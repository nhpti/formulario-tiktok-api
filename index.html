<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Empr√©stimo Bolsa Fam√≠lia</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #004bd4;
        font-family: "Montserrat", sans-serif;
      }

      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        flex-direction: column;
      }

      .card {
        background-color: #fff;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 20px;
      }

      .logo {
        margin-top: 20px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        margin: 5px;
      }

      .btn-green {
        background-color: #28a745;
        color: #fff;
      }

      .btn-red {
        background-color: #fff;
        color: red;
        border: 2px solid red;
      }

      .btn-gray {
        background-color: #ccc;
        color: #000;
      }

      .bold {
        font-weight: bold;
      }

      .step {
        display: none;
      }

      .visible {
        display: block;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .checkbox-label input {
        width: 18px;
        height: 18px;
        margin-right: 8px;
      }

      .whatsapp-icon {
        width: 50px;
        height: 50px;
        margin: 10px auto;
        display: block;
      }

      .full-width-img {
        width: 100%;
        border-radius: 10px;
        cursor: pointer;
      }

      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      /* Estilos do modal */
      #modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.75);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      #modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 90%;
        max-width: 500px;
      }

      .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #004bd4;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Etapas da LP -->
      <div class="card step visible" id="step1">
        <h2 style="color: #004bd4">Empr√©stimo Bolsa Fam√≠lia</h2>
        <h3 style="color: #004bd4">Requisitos para aprova√ß√£o:</h3>
        <p>1. Receber mais de R$400,00 reais por m√™s de benef√≠cio.</p>
        <p>2. N√£o ter outro empr√©stimo ativo no seu benef√≠cio.</p>
        <p class="bold">Voc√™ se encaixou nesses requisitos?</p>
        <button class="btn btn-green" onclick="nextStep(2)">SIM</button>
        <button class="btn btn-red" onclick="nextStep(6)">N√ÉO</button>
      </div>

      <div class="card step" id="step2">
        <h2 style="color: #004bd4">Conta Caixa Tem</h2>
        <img src="caixatem.jpg" alt="Caixa Tem" class="full-width-img" />
        <p>Voc√™ recebe o benef√≠cio pelo app Caixa Tem?</p>
        <button class="btn btn-green" onclick="nextStep(3)">SIM</button>
        <button class="btn btn-red" onclick="nextStep(7)">N√ÉO</button>
        <br />
        <button class="btn btn-gray" onclick="nextStep(1)">‚Üê Voltar</button>
      </div>

      <div class="card step" id="step3">
        <h2 style="color: #004bd4">Receba sua oferta pelo WhatsApp</h2>
        <img src="whatsapp.png" alt="WhatsApp" class="whatsapp-icon" />
        <p>Enviaremos uma proposta com as melhores condi√ß√µes para voc√™.</p>
        <label class="checkbox-label">
          <input
            type="checkbox"
            id="consentCheckbox"
            onchange="toggleContinue()"
          />
          Autorizo o envio de ofertas pelo WhatsApp
        </label>
        <button
          id="continueBtn"
          class="btn btn-gray"
          onclick="nextStep(4)"
          disabled
        >
          Continuar
        </button>
        <button class="btn btn-gray" onclick="nextStep(2)">‚Üê Voltar</button>
      </div>

      <div class="card step" id="step4">
        <h2 style="color: #004bd4">Informe seus dados</h2>
        <input type="text" id="nome" placeholder="Nome completo" />
        <input type="text" id="cpf" placeholder="CPF" />
        <div
          id="cpfError"
          style="
            color: red;
            display: none;
            margin-bottom: 10px;
            font-size: 0.95em;
          "
        ></div>
        <input type="text" id="telefone" placeholder="(DD) 9XXXXXXXX" />
        <div
          id="telefoneError"
          style="
            color: red;
            display: none;
            margin-bottom: 10px;
            font-size: 0.95em;
          "
        ></div>
        <button class="btn btn-green" onclick="submitForm()">Finalizar</button>
        <button class="btn btn-gray" onclick="nextStep(3)">‚Üê Voltar</button>
      </div>

      <div class="card step" id="step6">
        <h2 style="color: red">N√£o Eleg√≠vel ‚ùå</h2>
        <p>Infelizmente n√£o conseguimos atender voc√™ no momento.</p>
        <p>
          Quando voc√™ se enquadrar nos requisitos do cr√©dito, estaremos √†
          disposi√ß√£o para ajudar!
        </p>
        <button class="btn btn-gray" onclick="nextStep(1)">‚Üê Voltar</button>
      </div>

      <div class="card step" id="step7">
        <a
          href="https://www.tiktok.com/@novohorizontepromotora/video/7494309350379375878"
          target="_blank"
        >
          <img src="capa tutorial.png" alt="Tutorial" class="full-width-img" />
        </a>
        <br />
        <button class="btn btn-green" onclick="nextStep(3)">
          J√° recebo pelo Caixa Tem
        </button>
        <button class="btn btn-gray" onclick="nextStep(2)">‚Üê Voltar</button>
      </div>

      <img
        src="logo_horizontal_nhp_branco.png"
        alt="Logo Novo Horizonte"
        class="logo"
        width="150"
      />
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwencQZ3EcWFE76j6W8I4QZ3TckLJKNYdvwxAWjgxkGJQ2HCG1btVYdzYHZUQ_aWTCw0Q/exec";
      let currentStep = 1;

      function showStep(step) {
        document
          .querySelectorAll(".step")
          .forEach((s) => s.classList.remove("visible"));
        document.getElementById(`step${step}`).classList.add("visible");
        currentStep = step;
      }

      function nextStep(step) {
        showStep(step);
      }

      function toggleContinue() {
        const checkbox = document.getElementById("consentCheckbox");
        const btn = document.getElementById("continueBtn");
        btn.disabled = !checkbox.checked;
        btn.className = checkbox.checked ? "btn btn-green" : "btn btn-gray";
      }

      // Formata o campo de telefone enquanto o usu√°rio digita.
      function formatTelefoneInput(e) {
        const el = e.target;
        let digits = el.value.replace(/\D/g, "").slice(0, 11);

        if (digits.length === 0) {
          el.value = "";
          return;
        }

        if (digits.length <= 2) {
          el.value = "(" + digits;
        } else {
          const ddd = digits.slice(0, 2);
          const rest = digits.slice(2);
          el.value = "(" + ddd + ") " + rest;
        }
      }

      const telefoneInputEl = document.getElementById("telefone");
      if (telefoneInputEl) {
        telefoneInputEl.addEventListener("input", formatTelefoneInput);
        telefoneInputEl.addEventListener("paste", function (ev) {
          setTimeout(() => formatTelefoneInput({ target: telefoneInputEl }), 0);
        });
      }

      // M√°scara autom√°tica de CPF: 000.000.000-00
      function formatCpfInput(e) {
        const el = e.target;
        const digits = el.value.replace(/\D/g, "").slice(0, 11);

        if (digits.length <= 3) {
          el.value = digits;
        } else if (digits.length <= 6) {
          el.value = digits.slice(0, 3) + "." + digits.slice(3);
        } else if (digits.length <= 9) {
          el.value =
            digits.slice(0, 3) +
            "." +
            digits.slice(3, 6) +
            "." +
            digits.slice(6);
        } else {
          el.value =
            digits.slice(0, 3) +
            "." +
            digits.slice(3, 6) +
            "." +
            digits.slice(6, 9) +
            "-" +
            digits.slice(9, 11);
        }
      }

      const cpfInputEl = document.getElementById("cpf");
      if (cpfInputEl) {
        cpfInputEl.addEventListener("input", formatCpfInput);
        cpfInputEl.addEventListener("paste", function () {
          setTimeout(() => formatCpfInput({ target: cpfInputEl }), 0);
        });
      }

      // Valida√ß√£o matem√°tica do CPF (bloqueia no bot√£o Finalizar)
      function validarCPF(cpf) {
        cpf = String(cpf).replace(/[^\d]/g, "");

        if (cpf.length !== 11) return false;
        if (/^(\d)\1{10}$/.test(cpf)) return false;

        let soma = 0;
        let peso = 10;

        for (let i = 0; i < 9; i++) {
          soma += Number(cpf[i]) * peso;
          peso--;
        }

        let digito1 = (soma * 10) % 11;
        digito1 = digito1 > 9 ? 0 : digito1;

        soma = 0;
        peso = 11;

        for (let i = 0; i < 10; i++) {
          soma += Number(cpf[i]) * peso;
          peso--;
        }

        let digito2 = (soma * 10) % 11;
        digito2 = digito2 > 9 ? 0 : digito2;

        return cpf === cpf.substring(0, 9) + String(digito1) + String(digito2);
      }

      function submitForm() {
        function criarLead(nome, telefone, cpfDigits) {
          // Remove todos os caracteres n√£o num√©ricos do telefone e adiciona DDI 55
          const telefoneNumerico = "55" + telefone.replace(/\D/g, "");

          // Cria o lead
          fetch("https://api.g1.datacrazy.io/api/v1/leads", {
            method: "POST",
            headers: {
              Authorization:
                "Bearer dc_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MjljMjU1Mzk0NGQ3Mjg2MjQ3ZGEwNyIsInRlbmFudElkIjoiMDZiZmUyZjQtOTA0NC00YWY0LTgxMjMtMGQ5MzZkZjEwNmJjIiwibmFtZSI6IkZPUk1VTEFSSU8gQVBST1ZBRE8gQk9MU0EiLCJpYXQiOjE3NjQzNDQ0MDV9.8SXzxzLoJ9ZTozVO2QBXmp_Ym2u1aFHfVemh33uCX9Y",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: nome,
              phone: telefoneNumerico,
              taxId: cpfDigits,
              company: "ARRAIS",
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Lead criado:", data);
            })
            .catch((error) => {
              console.error("Erro ao criar lead:", error);
            });
        }
        const nome = document.getElementById("nome").value;
        const cpfEl = document.getElementById("cpf");
        const cpf = cpfEl.value;
        const telefoneEl = document.getElementById("telefone");
        const telefone = telefoneEl.value.trim();

        const telefoneErrorEl = document.getElementById("telefoneError");
        const cpfErrorEl = document.getElementById("cpfError");

        // reset errors
        telefoneErrorEl.style.display = "none";
        telefoneErrorEl.textContent = "";
        cpfErrorEl.style.display = "none";
        cpfErrorEl.textContent = "";

        if (!nome || !cpf || !telefone) {
          alert("Por favor, preencha todos os campos!");
          return;
        }

        // Valida√ß√£o telefone
        if (!/^\(\d{2}\)/.test(telefone)) {
          telefoneErrorEl.textContent =
            "Informe o DDD entre par√™nteses. Ex: (11) 9XXXXXXXX";
          telefoneErrorEl.style.display = "block";
          telefoneEl.focus();
          return;
        }

        const apenasDigitos = telefone.replace(/\D/g, "");
        if (apenasDigitos.length !== 11) {
          telefoneErrorEl.textContent =
            "Telefone inv√°lido. Digite DDD + telefone com 9 d√≠gitos (total 11 n√∫meros). Ex: (11) 9XXXXXXXX";
          telefoneErrorEl.style.display = "block";
          telefoneEl.focus();
          return;
        }

        // Valida√ß√£o CPF (apenas no bot√£o Finalizar)
        const cpfDigits = cpf.replace(/\D/g, "");
        if (!validarCPF(cpfDigits)) {
          cpfErrorEl.textContent = "CPF inv√°lido. Verifique os d√≠gitos.";
          cpfErrorEl.style.display = "block";
          cpfEl.focus();
          return;
        }

        const submitBtn = document.querySelector("#step4 .btn-green");
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";

        // Mostra p√°gina de carregamento
        const container = document.querySelector(".container");
        container.innerHTML = `
        <div class="card">
          <div style="display: flex; justify-content: center; align-items: center; height: 80px;">
            <div class="loader" style="border: 8px solid #f3f3f3; border-top: 8px solid #004bd4; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;"></div>
          </div>
          <h2 style="color: #004bd4; margin-top: 20px;">Estamos realizando sua consulta</h2>
          <p>Por favor, aguarde...n√£o saia daqui! √â rapidinho</p>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;

        // Envia o CPF para o webhook do n8n e trata a resposta
        fetch(
          "https://webhook.novohorizontepromotora.com.br/webhook/b4794b5f-05f5-42ac-bb3a-fed89d5033b2-producao",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              cpf: cpfDigits,
              telefone: telefone,
              nome: nome,
              parceiro: "tiktok bolsa",
            }),
          }
        )
          .then(async (response) => {
            let data;
            try {
              data = await response.json();
            } catch (e) {
              data = await response.text();
            }
            // N√£o mostra alerta nem interrompe o fluxo, apenas retorna o corpo da resposta
            return data;
          })
          .then((webhookData) => {
            let status = "";
            if (webhookData.retorno === "reprovado") {
              status = "reprovado";
              container.innerHTML = `
              <div class="card">
                <div style="font-size: 3em; color: red;">‚ùå</div>
                <h1 style="color: red;">N√£o aprovado</h1>
                <p>Infelizmente seu perfil n√£o foi aprovado para empr√©stimo.<br><br>${
                  webhookData.mensagem ? webhookData.mensagem : ""
                }</p>
                <button class="btn btn-gray" onclick="location.reload()">‚Üê Voltar ao in√≠cio</button>
              </div>
            `;
            } else if (webhookData.retorno === "triagem") {
              status = "triagem";
              // Apenas segue para a tela padr√£o de sucesso (fluxo normal)
            } else if (webhookData.retorno === "aprovado") {
              status = "aprovado";
              const especialistasLinks = [
                "https://curt.link/formbolsa",
                "https://curt.link/formbolsa2",
                "https://curt.link/formbolsa3",
                "https://curt.link/formbolsa4",
                "https://curt.link/formbolsa5",
                "https://curt.link/formbolsa6",
              ];
              const especialistaUrl =
                especialistasLinks[
                  Math.floor(Math.random() * especialistasLinks.length)
                ];
              container.innerHTML = `
              <div class="card">
                <div style="font-size: 3em; color: #28a745;">‚úîÔ∏è</div>
                <h1 style="color: #28a745;">Pr√©-aprovado!</h1>
                <p>Parab√©ns! Voc√™ foi pr√©-aprovado.<br>Em instantes voc√™ ser√° direcionado para um dos nossos especialistas no WhatsApp.</p>
                <p style="color: #004bd4; font-weight: bold;">Aguarde...</p>
              </div>
            `;
              criarLead(nome, telefone, cpfDigits);
              setTimeout(() => {
                window.location.href = especialistaUrl;
              }, 4000);
            } else {
              status = webhookData.retorno || "indefinido";
            }
            const formData = new URLSearchParams();
            formData.append("nome", nome);
            formData.append("cpf", cpfDigits);
            formData.append("telefone", telefone);
            formData.append("timestamp", new Date().toISOString());
            formData.append("status", status);
            formData.append("mensagem", webhookData.mensagem || "");

            fetch(scriptURL, {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.result === "success") {
                  if (status === "triagem" || status === "indefinido") {
                    const hora = new Date().getHours();
                    const dia = new Date().getDay();
                    const especialistas = Math.floor(Math.random() * 11) + 25;
                    const emHorario =
                      dia >= 1 && dia <= 5 && hora >= 8 && hora < 18;

                    container.innerHTML = `
                    <div class="card">
                      <div style="font-size: 3em;">üòâ</div>
                      <h1 style="color: green;">Tudo certo!</h1>
                      <p style="margin: 20px 0;">
                        ${
                          emHorario
                            ? `Um especialista entrar√° em contato pelo WhatsApp com sua proposta.<br><br><strong style="color: green;">‚óè ${especialistas} especialistas online agora!</strong>`
                            : `Recebemos seus dados com sucesso!<br><br><strong style="color: orange;">‚óè Fora do hor√°rio comercial</strong><br>Segunda √† sexta, das 8h √†s 18h`
                        }
                      </p>
                      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" class="whatsapp-icon" />
                      <p><strong>Aguarde nossa mensagem no WhatsApp!</strong></p>
                      <br>
                    </div>
                  `;
                  }
                  // Para reprovado e aprovado, a tela j√° foi tratada acima
                } else {
                  alert("Erro ao enviar os dados. Tente novamente.");
                }
              })
              .catch((error) => {
                console.error("Erro:", error);
                alert("Erro ao enviar dados. Tente novamente.");
              })
              .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = "Finalizar";
              });
          })
          .catch((error) => {
            console.error("Erro:", error);
            // Removido alert para n√£o mostrar popup ao usu√°rio
            submitBtn.disabled = false;
            submitBtn.textContent = "Finalizar";
          });
      }
    </script>
  </body>
</html>
